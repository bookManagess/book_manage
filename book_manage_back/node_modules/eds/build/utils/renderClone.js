const fs = require('fs');
const path = require('path');
const cheerio = require('cheerio');
const _ = require('lodash');

module.exports = function renderClone(file, drawioHTMLs) {
  const html = file.contents.toString();
  const $ = cheerio.load(html);
  const $drawio = $('[data-edstarget="drawio"]');
  const version = path.dirname(file.path).split(path.sep).pop();

  $drawio.each(function() {
    const folderName = $(this).data('edsfoldername');
    const clone = $(this).clone().html();
    const $parent = $(this).parent();
    let newHtml = '';
    _.forEach(drawioHTMLs[version], (filePath) => {
      const lastfolder = path.dirname(filePath).split(path.sep).pop();
      if (lastfolder === folderName) {
        const fileName = path.basename(filePath, '.html');
        const file = fs.readFileSync(`./temp/${version}/drawio/${folderName}/${fileName}.html`, 'utf8');
        newHtml += clone.replace(/{{fileName}}/g, fileName).replace(/{{file}}/g, file);
      }
    });
    $(this).html(newHtml);
  });

  return $.html();
}